# Roguelike Game v2.0

一款使用纯 JavaScript + Canvas 开发的 Roguelike 射击游戏。

## 🎮 游戏特性

- **自动战斗**：玩家自动向最近的敌人发射子弹
- **武器系统**：多种基础武器和进化武器，支持武器合成
- **武器图鉴**：查看全部武器的图标、数值面板、合成材料、描述与效果
- **状态效果**：燃烧、冰冻、中毒、致盲等多种效果，支持状态图鉴
- **升级系统**：通过击杀敌人获得经验，升级后获得技能点
- **宝箱系统**：击杀敌人掉落宝箱，进化/融合/道具/金币四选一
- **道具系统**：宝箱概率掉落道具，局内生效，可随撤离带回基地

## 🚀 快速开始

### 方式一：使用启动脚本
双击 `启动游戏.bat` 即可启动游戏服务器并打开浏览器。

### 方式二：命令行启动
```bash
npm install      # 首次运行需安装依赖
npm run serve    # 启动服务器
```
然后访问 http://localhost:8080/

## 🎯 操作说明

| 按键 | 功能 |
|------|------|
| W/A/S/D | 移动 |
| E | 打开升级菜单（有技能点时） |
| ESC | 关闭菜单 |
| 鼠标点击 | 右侧「角色武器」面板标题的「图鉴」按钮，打开武器图鉴 |

## 📁 项目结构

```
js/
├── artifacts/      # 道具模块
├── core/           # 核心模块 (Game, Player, PlayerStats)
├── combat/         # 战斗模块 (Bullet, BulletPool, CollisionManager, AOEHandler)
├── enemies/        # 敌人模块 (Enemy, StatusEffects)
├── weapons/        # 武器模块 (Weapon, WeaponSystem, WeaponsData)
├── effects/        # 视觉特效
├── ui/             # UI 组件
└── chest/          # 宝箱系统
```

## 🧪 运行测试

```bash
npm test
```

## 🔧 融合表生成

融合配方由脚本自动生成（基础武器 + 进化武器两两组合）。当武器数据有变更时，请重新生成：

```bash
npm run generate:fusion-recipes
```

## 📋 开发日志

### 2026/2/3
- 🌟 **进化武器「闪烁」重做**：
  - 「日蚀」更名为「闪烁」（ID `eclipse`）
  - 效果改为全屏伤害，伤害下调至 0.5
  - 图标改为 🌟
- ⚔️ **秒杀机制**：
  - 裂地锤：直击 2% 秒杀（连锁/范围为 0.2%）
  - 冰锥：碎冰触发后 5% 秒杀（连锁/范围为 0.5%）
  - 状态图鉴新增“秒杀”并展示来源武器
- 📚 **图鉴补全**：
  - 攻击方式/范围新增“全屏”标签与详情显示
- 🔗 **融合表同步**：
  - 重新生成融合配方（`node tools/generate-fusion-recipes.js`）
- 🧰 **道具系统落地**：
  - 宝箱每 3~4 个出现一次道具选项（进化 → 融合 → 道具 → 金币）
  - 道具详情弹窗确认获取，满槽自动隐藏道具入口
- 🧪 **道具数据与效果**：
  - 新增 18 个道具定义（效果/代价）
  - 道具效果联动氧气/移速/伤害/DOT/射线致盲/AOE/宝箱/撤离
- 💾 **道具持久化**：
  - MetaStore 增加 `artifacts` 进度，撤离成功入库、死亡清空局内道具
- 🧪 **测试补充**：
  - 新增 ArtifactSystem 与 MetaStore 道具流程测试
- 🎒 **背包道具展示**：
  - 背包栏固定 4 格，道具获取后显示图标与名称
- 📖 **道具图鉴**：
  - 背包面板新增“图鉴”按钮，支持搜索与详情弹窗
  - 道具图鉴默认展示全部道具
- 🧭 **状态图鉴补充**：
  - “易伤”说明默认值仅在未配置时使用，且不可叠层
- 🗼 **避雷针与引雷机制**：
  - 「磁轨」更名为「避雷针」，伤害调整为 0.8，保留连锁闪电
  - 新增“引雷”Debuff：命中后每 1s 触发 3 次雷击，命中刷新次数
  - 雷击可连锁并继承其他状态，避免重复施加引雷
  - 避雷针与引雷图标统一为 🗼
- 🔗 **融合表同步**：
  - 重新生成融合配方（`node tools/generate-fusion-recipes.js`）

### 2026/2/2
- 🎨 **玩家占位图**：
  - 新增 `player_placeholder.svg`，玩家渲染优先使用贴图，失败回退圆形
- 🧰 **资源预加载**：
  - 新增 AssetManager + Sprites，启动时预加载贴图
- 🧪 **测试补充**：
  - 新增 AssetManager 资源加载测试

### 2026/2/1
- 🎯 **升级随机加点反馈**：
  - 每次升级随机+1力量/智力
  - 玩家头顶飘字提示“力量+1/智力+1”
- ⚡ **进化武器调整**：
  - “吸雷链”更名为“雷汲脉冲”（ID `leech_arc`）
  - 伤害下调至 0.5，半径下调至 4
- 🖤 **暗焰机制重做**：
  - 黑焰DOT（30s，0.04/f，吃智力倍率）+ 接触传播（1s间隔）
  - 与燃烧共存，黑焰视觉优先显示
- 🔗 **融合表同步**：
  - 重新生成融合配方（`npm run generate:fusion-recipes`）
- 🏠 **局外基地系统**：
  - 启动即进入基地，局内/局外全屏切换（不再是弹窗）
  - 撤离或死亡后回到基地
- 📈 **永久成长与进度**：
  - 新增局外进度持久化（金币/统计/解锁）
  - 永久升级项：氧气上限/力量/智力（基地面板购买）
  - 预留仓库/出航携带/战利品字段
- 🧭 **基地布局调整**：
  - 纵向结构：金币 → 开始潜水 → 航行日志（含航次/最深距离）→ 升级面板 → 仓库
- 🧪 **编码检查工具**：
  - 新增 `npm run scan:encoding` 扫描乱码与替代字符
- 🩸 **海渊献祭状态**：
  - 新增“海渊献祭”Debuff，敌人死亡时回复玩家氧气（固定+2，10s，只刷新时长）
  - 新增进化武器「渊灵」（幽灵 + 吸血）：穿透 + 海渊献祭
- 🧿 **进化武器调整**：
  - 「血咒」改为“诅咒 + 海渊献祭”
  - 「鬼火」改为“穿透 + 黑焰”，伤害下调至 0.5
- ✨ **圣愈重制**：
  - 「血辉」更名为「圣愈」（ID `holy_heal`）
  - 伤害下调至 0.1，吸血概率提升至 21%，移除致盲
- 🔥 **高温射线重做**：
  - 「太阳束」更名为「高温射线」（ID `high_temperature_ray`）
  - 半径减半、伤害提升至 3.5、间隔 45f，仅保留射线 AOE
- 🧭 **UI 细节调整**：
  - 距离显示改为米制（保留 1 位小数）
  - 升级提示移至左上角
  - 局外基地文案更新，潜水日志与升级面板同排布局
- 📊 **属性显示与倍率调整**：
  - 力量/智力初始改为 5
  - 伤害与 DOT 倍率改为按 `(属性 + 45)` 计算，保持实际强度不变

### 2026/1/31
- 🧰 **宝箱交互重构**：
  - 宝箱奖励改为一级菜单（进化/融合/金币），进化与融合进入二级弹窗
  - 融合改为手动双选当前武器，不再穷举列表；ESC 在二级返回一级，一级默认选金币
- 📦 **宝箱掉落体验优化**：
  - 宝箱生成时自动下移并带随机横向偏移，避免贴近屏幕上沿
  - 生成后执行“快速下落→减速→缓慢漂移”两段运动，漂移速度低于滚动速度，仍可能错过
- 🎨 **UI 风格调整**：
  - 返回按钮改用通用暗色样式 `.btn-muted`，避免默认黄色干扰
  - 进化/融合弹窗标题居中放大，返回按钮缩小并定位右上
- 📚 **图鉴增强**：
  - 武器详情新增“可能进化的武器类型”，展示完整配方（材料 + 产物）
- 🧭 **进化/融合架构调整**：
  - 进化表统一为 `WEAPON_EVOLUTION_TABLE`，并同步草案文件命名
  - 进化/融合逻辑收敛到武器模块，宝箱仅负责流程编排
- 🧪 **敌人体系调整**：
  - 敌人改为海洋主题命名（狮子鱼/泰坦扳机鱼/鳗鲶/毒刺水母/三齿鲨）
  - 新增海马：仅浅层刷新、无伤害、水平往返并带上下波动
  - 敌人生成支持权重，浅层海马出现频率高于狮子鱼
- ⚡ **进化武器清理与命名**：
  - “幽电”更名为“电魂”（ID `electric_soul`），配方与引用同步更新
  - 删除进化武器“闪袭”（光芒 + 疾风）并清理配方

### 2026/1/30
- 🌀 **融合机制落地**：
  - 宝箱奖励顺序：进化 → 融合 → 金币，金币默认可选且 ESC 自动选金币
  - 融合形态占 1 槽位、不可拆分/不可再进化/不可再融合
  - 融合配方自动生成并支持同步提醒（未更新会提示）
- 📚 **图鉴增强**：
  - 新增“状态图鉴”页签，展示状态参数与来源武器
  - “岩脊带控场”纳入状态图鉴
- 🪙 **宝箱奖励升级**：
  - 无论可否进化都弹窗，支持金币奖励（随风险区间微增）
- 🧿 **初始武器调整**：
  - 开局默认“普通弹珠”，获得任意新武器后自动替换
- 🗑️ **进化武器精简**：
  - 移除 29 把基础拼接型进化武器（分裂/穿透/高伤/高速/致盲/中毒/燃烧/冻结/连锁/射线/吸血等组合）
  - 同步删除对应合成配方与图标映射，降低同质化
- 📖 **图鉴扩展**：
  - 新增“攻击方式/范围”图鉴，按射线/圆形AOE/爆炸/连锁/穿透/分裂/天降/直线弹道归类
  - 支持多标签归类，同一武器可出现在多个分类
- 🧾 **编码与草案修复**：
  - 修复武器草案与生成器的乱码问题，并重新生成草案
  - 新增 `.editorconfig` 与 `.vscode/settings.json` 统一 UTF-8 与换行格式
- 🪨 **岩石系进化重构**：
  - 熔岩/冰川/幽冥石/晶耀/雷砾/沼泽/地脉束/裂地锤 替换旧配方与ID
  - 岩石系引入「顶落岩石」与「岩脊带控场」通用机制
- 🧱 **地形控场增强**：
  - 岩脊带改为随机方向，尺寸缩小，持续时间缩短为2秒

### 2026/1/29
- 🧪 **调试覆盖层增强**：
  - 状态面板新增“减益/控制”分组，并显示剩余时长详情
- 🎯 **撤离点绘制修正**：
  - 绘制撤离点时隔离 Canvas 状态，避免影响调试层对齐
- 🧿 **诅咒机制完善**：
  - 诅咒层数受击消耗并触发额外伤害，调试/图鉴同步显示
- 🧬 **进化武器调整**：
  - 修订 5 个进化武器的配方与效果数据
- 🌱 **蔓延进化与叠层爆发**：
  - 细胞 + 岩石 进化为「蔓延」，叠层至3层触发爆发AOE
  - 爆发伤害吃智力倍率，AOE/连锁命中也可叠层触发
- 🦠 **瘟疫进化与扩散DOT**：
  - 新增进化武器「瘟疫」，命中叠层并在10s内独立计时，2 DPS/层
  - 细胞/黑暗/幽灵/吸血 + 剧毒统一合成瘟疫，移除毒孢群/疫咒/毒灵/吸毒正式定义
  - 新增瘟疫传播与死亡残留云雾机制，活体与死亡云雾同尺寸
- 🧊 **碎冰与冰锥**：
  - 命中前冻结目标触发碎冰倍伤并破冰，避免同击补冰
  - 冰霜 + 钢铁 进化为「冰锥」
- 🧾 **配方命名清理**：
  - 移除融合结果名称里的“进化”字样
- ☢️ **辐射进化与易伤机制**：
  - 进化武器替换为「辐射射线」（细胞/剧毒/幽灵 + 射线）
  - 新增辐射易伤：每层+10%，10s独立计时，最多叠加5层
- 📚 **武器图鉴**：
  - 新增图鉴入口与二级详情弹窗，支持搜索与数值面板展示
- 🧪 **状态叠加规则调整**：
  - 中毒改为独立层计时，易伤倍率按层数累计
- 🛠️ **战斗修复与测试**：
  - 修复进化后旧效果残留（子弹池重置清理）
  - 新增状态叠加与子弹重置测试
- 🧰 **调试覆盖层**：
  - `~` 开关显示 FPS/敌人/子弹/特效/DOT 汇总
- 🔥 **状态特效模块化**：
  - 新增燃烧/中毒/冰冻独立特效模块，并统一由 StatusVFXManager 管理
  - 特效与状态效果绑定，支持粒子数量随体型与层数变化
- 🧹 **死亡清理**：
  - 敌人死亡后自动移除其状态特效，避免残留
- 🧪 **测试补充**：
  - 新增 effects 下的特效与管理器测试用例


### 2026/1/28
- 🧩 **武器进化与合成扩展**：
  - 新增72把进化武器与78条融合配方，并补齐ID映射与图标映射
  - 保留进化草案输出，新增武器数据校验脚本
- ⚡ **战斗与状态效果完善**：
  - AOE/连锁/射线命中同步触发DOT、冻结、致盲、吸血等
  - 链电冷却生效，射线伤害计算修正，燃烧支持自定义颜色
- 🎯 **升级池补全**：
  - 基础武器池覆盖细胞/射线/岩石/幽灵等所有基础武器
  - 新增对应测试用例

### 2026/1/23
- ✨ **撤离玩法深度增强**：
  - 📡 **撤离点召唤机制**：玩家可消耗1点能源随时发送撤离信号，队友将在5秒后于下方刷新撤离点。
  - 🏮 **全局压力系统 - 视觉衰减**：屏幕亮度随深度平滑变暗，最深处仅保留30%可见度，增加紧张感。
  - 💨 **全局压力系统 - 氧气加速**：氧气消耗不再恒定，随深度指数级加速（4s -> 0.8s每点）。
  - ⚔️ **P2 风险跳跃曲线**：敌人生成频率和死亡惩罚根据深度区间动态调整（300m/500m/800m/1200m）。
  - 🚁 **P3 撤离试炼**：进入撤离区域时触发敌人围攻，围攻规模随深度区间增加（6~30只敌人）。
- 🔧 **交互逻辑优化**：
  - 允许在武器栏满时打开菜单进行撤离召唤（显示「武器栏已满」）。
  - 修正召唤撤离点的垂直偏移，确保其从屏幕底部平滑滚入，避免一闪而过。
  - 死亡弹窗文字改为动态显示当前区域的金币保留比例。
  - 进入新深度区间时红字警告：「光线变暗了……危险更多了……氧气消耗也加快了……」
- 🏗️ **架构重构**：
  - 统一深度区间配置至 `RiskSystem.js`，所有深度相关系统从同一数据源读取。
  - 围攻敌人生成逻辑移至 `EvacuationManager.js`，保持 `Game.js` 简洁。
- 🧪 **自动化测试完善**：
  - 新增 RiskSystem (11)、OxygenSystem (5)、LightingSystem (4)、EvacuationManager (19) 共 39+ 个测试用例。

### 2026/1/21
- ✨ 新增**撤离系统**：搜打撤玩法核心机制
  - 每500米生成撤离点，停留3秒成功撤离
  - 撤离成功保留100%金币，死亡保留50%
  - 创建 `EvacuationManager.js`、`MetaProgress.js`、`EvacuationResultUI.js`
- 🎨 更新武器图标（疾风💨、钢铁🔩、燃霜💠等）
- 🔧 武器进化界面改为图标显示材料
- ⚙️ 氧气消耗速度可配置（当前每4秒扣1血）
- 添加氧气消耗系统，创建 `OxygenSystem.js` 模块
- UI 文本调整：生命值→氧气、经验→充能进度、技能点→能源
- 宝箱功能重构：从"获取新武器"改为"武器进化"

### 2026/1/20
- 添加子弹扩散功能（多武器子弹不再重叠）
- 重构目录结构，创建 `combat/` 模块
- 将 `upgradeAttack()` 改为 `upgradeStrength()`
- 拆分 `CollisionManager`，提取 `AOEHandler`
- 将状态效果应用逻辑移至 `StatusEffects.js`

### 2026/1/18
- 实现宝箱掉落系统（从敌人死亡处掉落）

### 2026/1/17
- 重构状态效果系统，创建 `StatusEffect` 模块
